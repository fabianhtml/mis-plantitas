<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Plantitas - Calendario de Riego</title>
    <meta name="description" content="Calendario de riego para mis plantitas. Jade, Sansevieria y Canelo.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå±</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --jade: #2D5A45;
            --jade-light: #4A7C59;
            --sansevieria: #8B6914;
            --sansevieria-light: #C4A052;
            --canelo: #1B5E3F;
            --canelo-light: #2E7D5A;
            --cream: #FDF8F0;
            --earth: #3D2914;
            --earth-light: #5C4033;
            --sage: #9CAF88;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--earth);
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                radial-gradient(ellipse at 10% 20%, rgba(156, 175, 136, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(196, 160, 82, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(45, 90, 69, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 1rem; }
        header { text-align: center; padding: 1.5rem 0; animation: fadeInDown 0.8s ease-out; }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            color: var(--jade);
            margin-bottom: 0.5rem;
        }
        h1 span { display: inline-block; animation: wave 2s ease-in-out infinite; }
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
        }
        .subtitle { font-size: 1rem; color: var(--earth-light); opacity: 0.95; }
        .plants-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 1.2rem 0;
        }
        .plant-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(61, 41, 20, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out backwards;
        }
        .plant-card:nth-child(1) { animation-delay: 0.2s; }
        .plant-card:nth-child(2) { animation-delay: 0.4s; }
        .plant-card:nth-child(3) { animation-delay: 0.6s; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .plant-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(61, 41, 20, 0.15); }
        .plant-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 5px;
        }
        .plant-card.jade::before { background: linear-gradient(90deg, var(--jade), var(--jade-light)); }
        .plant-card.sansevieria::before { background: linear-gradient(90deg, var(--sansevieria), var(--sansevieria-light)); }
        .plant-card.canelo::before { background: linear-gradient(90deg, var(--canelo), var(--canelo-light)); }
        .plant-icon { font-size: 3rem; margin-bottom: 0.8rem; display: block; }
        .plant-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .plant-card.jade .plant-name { color: var(--jade); }
        .plant-card.sansevieria .plant-name { color: var(--sansevieria); }
        .plant-card.canelo .plant-name { color: var(--canelo); }
        .plant-scientific {
            font-style: italic;
            color: var(--earth-light);
            font-size: 0.85rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        .water-info {
            background: var(--cream);
            border-radius: 10px;
            padding: 0.8rem;
            margin: 0.8rem 0;
        }
        .water-info p {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.2rem 0;
            font-size: 0.9rem;
        }
        .next-water {
            font-weight: 600;
            padding: 0.7rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 0.8rem;
            font-size: 0.9rem;
        }
        .plant-card.jade .next-water {
            background: linear-gradient(135deg, var(--jade), var(--jade-light));
            color: white;
        }
        .plant-card.sansevieria .next-water {
            background: linear-gradient(135deg, var(--sansevieria), var(--sansevieria-light));
            color: white;
        }
        .plant-card.canelo .next-water {
            background: linear-gradient(135deg, var(--canelo), var(--canelo-light));
            color: white;
        }
        .last-water-info {
            font-size: 0.85rem;
            color: var(--earth-light);
            margin: 0.5rem 0;
        }
        .water-btn {
            display: block;
            width: 100%;
            padding: 0.7rem 1rem;
            margin-top: 0.8rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .plant-card.jade .water-btn {
            background: var(--cream);
            color: var(--jade);
            border: 2px solid var(--jade);
        }
        .plant-card.jade .water-btn:hover {
            background: var(--jade);
            color: white;
        }
        .plant-card.sansevieria .water-btn {
            background: var(--cream);
            color: var(--sansevieria);
            border: 2px solid var(--sansevieria);
        }
        .plant-card.sansevieria .water-btn:hover {
            background: var(--sansevieria);
            color: white;
        }
        .plant-card.canelo .water-btn {
            background: var(--cream);
            color: var(--canelo);
            border: 2px solid var(--canelo);
        }
        .plant-card.canelo .water-btn:hover {
            background: var(--canelo);
            color: white;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.8rem;
            margin: 1.2rem 0;
        }
        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(61, 41, 20, 0.06);
        }
        .stat-number {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--jade);
        }
        .stat-label { font-size: 0.8rem; color: var(--earth-light); margin-top: 0.2rem; opacity: 0.95; }
        .calendar-section { margin-top: 2rem; }
        .today-section { margin: 1rem 0 1.5rem; }
        .today-card {
            background: white;
            border-radius: 18px;
            padding: 1.2rem;
            box-shadow: 0 6px 20px rgba(61, 41, 20, 0.08);
            text-align: center;
        }
        .today-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: var(--earth);
            margin-bottom: 0.3rem;
        }
        .today-message {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--jade);
            margin-bottom: 0.3rem;
        }
        .today-message.no { color: var(--earth-light); }
        .today-sub {
            font-size: 0.9rem;
            color: var(--earth-light);
        }
        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.8rem;
            text-align: center;
        }
        .today-badge {
            background: #E74C3C;
            color: white;
            padding: 0.4rem 0.7rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(231, 76, 60, 0.25);
            cursor: pointer;
            user-select: none;
        }
        .calendar-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            color: var(--earth);
        }
        .year-nav { display: flex; align-items: center; gap: 0.8rem; }
        .year-nav button {
            background: white;
            border: 2px solid var(--sage);
            color: var(--earth);
            width: 42px; height: 42px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .year-nav button:hover {
            background: var(--jade);
            border-color: var(--jade);
            color: white;
        }
        .year-display {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
            min-width: 70px;
            text-align: center;
        }
        .legend {
            display: flex;
            gap: 1.2rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(61, 41, 20, 0.05);
        }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; }
        .legend-dot.jade { background: var(--jade); }
        .legend-dot.sansevieria { background: var(--sansevieria); }
        .legend-dot.canelo { background: var(--canelo); }
        .legend-dot.both { background: linear-gradient(135deg, var(--jade) 50%, var(--sansevieria) 50%); }
        .legend-dot.today { background: #E74C3C; }
        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .month-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(61, 41, 20, 0.06);
            transition: transform 0.3s ease;
        }
        .month-card:hover { transform: scale(1.02); }
        .month-header {
            background: linear-gradient(135deg, var(--earth), var(--earth-light));
            color: white;
            padding: 0.8rem;
            text-align: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .month-body { padding: 0.8rem; }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.7rem;
            color: var(--earth-light);
            margin-bottom: 0.4rem;
            font-weight: 600;
            opacity: 0.95;
        }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border-radius: 50%;
            position: relative;
            transition: all 0.2s ease;
            cursor: default;
        }
        .day.empty { visibility: hidden; }
        .day.water-jade { background: var(--jade); color: white; font-weight: 600; }
        .day.water-sansevieria { background: var(--sansevieria); color: white; font-weight: 600; }
        .day.water-both { background: linear-gradient(135deg, var(--jade) 50%, var(--sansevieria) 50%); color: white; font-weight: 600; }
        .day.water-jade-done {
            background: white;
            color: var(--jade);
            border: 2px solid var(--jade);
            font-weight: 600;
        }
        .day.water-sansevieria-done {
            background: white;
            color: var(--sansevieria);
            border: 2px solid var(--sansevieria);
            font-weight: 600;
        }
        .day.water-both-done {
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, var(--jade) 50%, var(--sansevieria) 50%) border-box;
            border: 2px solid transparent;
            color: var(--earth);
            font-weight: 600;
        }
        .day.today { box-shadow: 0 0 0 3px #E74C3C, 0 6px 12px rgba(231, 76, 60, 0.25); }
        .day.past { opacity: 0.4; }
        .day:not(.empty):hover { box-shadow: 0 0 0 2px rgba(45, 90, 69, 0.25); z-index: 10; }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--earth-light);
            font-size: 0.85rem;
        }
        footer span { color: #E74C3C; }
        .tooltip {
            position: fixed;
            background: var(--earth);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        .tooltip.show { opacity: 1; }
        .tooltip.wrap { white-space: normal; max-width: 260px; }
        .water-note-trigger { cursor: help; font-size: 0.85em; opacity: 0.85; margin-left: 0.2rem; }
        .water-note-trigger:hover { opacity: 1; }
        
        /* Modal de confirmaci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 320px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--earth);
            margin-bottom: 1.5rem;
        }
        .modal-buttons {
            display: flex;
            gap: 0.8rem;
        }
        .modal-btn {
            flex: 1;
            padding: 0.8rem 1rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-btn.cancel {
            background: var(--cream);
            border: 2px solid var(--earth-light);
            color: var(--earth-light);
        }
        .modal-btn.cancel:hover {
            background: var(--earth-light);
            color: white;
        }
        .modal-btn.confirm {
            background: var(--jade);
            border: 2px solid var(--jade);
            color: white;
        }
        .modal-btn.confirm:hover {
            background: var(--jade-light);
            border-color: var(--jade-light);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--earth);
            color: white;
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-text {
            font-weight: 500;
        }
        .toast-undo {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toast-undo:hover {
            background: white;
            color: var(--earth);
        }
        @media (min-width: 700px) {
            .container { padding: 1.5rem; }
            header { padding: 2rem 0; }
            .plants-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
            .stats { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
            .calendar-header { justify-content: space-between; text-align: left; gap: 1rem; }
            .calendar-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Modal de confirmaci√≥n -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-icon" id="modal-icon">ü™¥</div>
            <div class="modal-title" id="modal-title">¬øRegaste la Jade hoy?</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modal-cancel">Cancelar</button>
                <button class="modal-btn confirm" id="modal-confirm">S√≠, regu√©</button>
            </div>
        </div>
    </div>
    
    <!-- Toast de confirmaci√≥n con deshacer -->
    <div class="toast" id="toast">
        <span class="toast-text">Guardado</span>
        <button class="toast-undo" id="toast-undo">Deshacer</button>
    </div>
    
    <div class="container">
        <header>
            <h1><span>üå±</span> Mis Plantitas</h1>
            <p class="subtitle">Calendario de riego</p>
        </header>
        <section class="today-section">
            <div class="today-card">
                <div>
                    <div class="today-title">¬øToca regar hoy?</div>
                    <div class="today-message" id="today-message">Cargando...</div>
                    <div class="today-sub" id="today-sub">Calculando pr√≥ximo riego...</div>
                </div>
            </div>
        </section>
        <div class="plants-grid">
            <div class="plant-card jade">
                <span class="plant-icon">ü™¥</span>
                <h2 class="plant-name">Jade</h2>
                <p class="plant-scientific">Crassula ovata</p>
                <div class="water-info">
                    <p>üíß <strong>100 ml</strong> cada <strong>2 semanas</strong></p>
                </div>
                <div class="last-water-info" id="last-jade-info">√öltimo riego: cargando...</div>
                <div class="next-water" id="next-jade">Cargando...</div>
                <button class="water-btn" data-plant="jade">Regu√© hoy</button>
            </div>
            <div class="plant-card sansevieria">
                <span class="plant-icon">üåø</span>
                <h2 class="plant-name">Sansevieria</h2>
                <p class="plant-scientific">Sansevieria trifasciata</p>
                <div class="water-info">
                    <p>üíß <strong>100 ml</strong> cada <strong>mes</strong></p>
                </div>
                <div class="last-water-info" id="last-sansev-info">√öltimo riego: cargando...</div>
                <div class="next-water" id="next-sansevieria">Cargando...</div>
                <button class="water-btn" data-plant="sansevieria">Regu√© hoy</button>
            </div>
            <div class="plant-card canelo">
                <span class="plant-icon">üå≤</span>
                <h2 class="plant-name">Canelo</h2>
                <p class="plant-scientific">Drimys winteri</p>
                <div class="water-info">
                    <p>üíß <strong>50‚Äì80 ml</strong> cada <strong>semana</strong> <span class="water-note-trigger" data-tooltip="Suelo h√∫medo sin encharcar. En vasito peque√±o seca r√°pido." onmouseenter="showTooltip(event)" onmouseleave="hideTooltip()" role="img" aria-label="Nota">‚ÑπÔ∏è</span></p>
                </div>
                <div class="last-water-info" id="last-canelo-info">√öltimo riego: cargando...</div>
                <div class="next-water" id="next-canelo">Cargando...</div>
                <button class="water-btn" data-plant="canelo">Regu√© hoy</button>
            </div>
        </div>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-jade">0</div>
                <div class="stat-label">Riegos Jade</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-sansevieria">0</div>
                <div class="stat-label">Riegos Sansevieria</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-canelo">0</div>
                <div class="stat-label">Riegos Canelo</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-water">0</div>
                <div class="stat-label">Litros al a√±o</div>
            </div>
        </div>
        <section class="calendar-section">
            <div class="calendar-header">
                <h2 class="calendar-title">üìÜ Calendario de Riego</h2>
                <span class="today-badge" id="today-badge">Hoy</span>
                <div class="year-nav">
                    <button onclick="changeYear(-1)" aria-label="A√±o anterior">‚Äπ</button>
                    <span class="year-display" id="year-display">2025</span>
                    <button onclick="changeYear(1)" aria-label="A√±o siguiente">‚Ä∫</button>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot jade"></div><span>Jade</span></div>
                <div class="legend-item"><div class="legend-dot sansevieria"></div><span>Sansevieria</span></div>
                <div class="legend-item"><div class="legend-dot canelo"></div><span>Canelo</span></div>
                <div class="legend-item"><div class="legend-dot both"></div><span>Jade + Sansevieria</span></div>
                <div class="legend-item"><div class="legend-dot today"></div><span>Hoy</span></div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </section>
        <footer>Hecho con <span>‚ô•</span> para mis plantitas</footer>
    </div>
    <script>
        // Configuraci√≥n simple: fechas de √∫ltimo riego conocidas
        // Jade: cada 2 semanas (14 d√≠as)
        // Sansevieria: 1 vez al mes
        // Canelo: cada semana (suelo h√∫medo, maceta chica)
        const JADE_INTERVAL = 14;
        const SANSEVIERIA_INTERVAL_MONTHS = 1;
        const CANELO_INTERVAL = 7;
        
        // Fechas correctas de √∫ltimo riego (cuando no hay historial en API)
        const CORRECT_LAST_JADE = new Date(2026, 0, 19); // 19 de enero 2026
        const CORRECT_LAST_SANSEVIERIA = new Date(2026, 0, 30); // 30 de enero 2026
        const CORRECT_LAST_CANELO = new Date(2026, 1, 2); // 2 feb 2026 ‚Üí pr√≥ximo 9 feb
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let currentYear = today.getFullYear();
        
        const STORAGE_KEYS = {
            jade: 'last-watered-jade',
            sansevieria: 'last-watered-sansevieria',
            canelo: 'last-watered-canel'
        };
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const weekDays = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

        // === Funciones de fecha ===
        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() && 
                   date1.getMonth() === date2.getMonth() && 
                   date1.getFullYear() === date2.getFullYear();
        }

        function formatDate(date) {
            return `${date.getDate()} de ${monthNames[date.getMonth()]}`;
        }

        function formatDateWithYear(date) {
            return `${date.getDate()} de ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
        }

        function daysUntil(date) {
            return Math.ceil((date - today) / (1000 * 60 * 60 * 24));
        }

        function toLocalISODate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function parseLocalDateString(value) {
            const parts = value.split('-').map(Number);
            if (parts.length !== 3) return null;
            const [y, m, d] = parts;
            if (!y || !m || !d) return null;
            const date = new Date(y, m - 1, d);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        // === Almacenamiento (Historial) ===
        // Cache local del historial de riegos (arrays de fechas)
        let wateringHistory = {
            jade: [CORRECT_LAST_JADE],
            sansevieria: [CORRECT_LAST_SANSEVIERIA],
            canelo: []
        };
        
        function getWateringHistory(type) {
            return wateringHistory[type] || [];
        }
        
        function getLastWatered(type) {
            const history = getWateringHistory(type);
            if (history.length > 0) {
                return history[history.length - 1];
            }
            if (type === 'jade') return CORRECT_LAST_JADE;
            if (type === 'sansevieria') return CORRECT_LAST_SANSEVIERIA;
            return CORRECT_LAST_CANELO;
        }

        function addWatering(type, date) {
            const history = wateringHistory[type];
            const dateStr = toLocalISODate(date);
            // No agregar duplicados
            if (!history.some(d => toLocalISODate(d) === dateStr)) {
                history.push(date);
                history.sort((a, b) => a - b);
            }
            // Guardar en API
            saveToAPI(type, date);
        }
        
        function removeWatering(type, date) {
            const history = wateringHistory[type];
            const dateStr = toLocalISODate(date);
            const index = history.findIndex(d => toLocalISODate(d) === dateStr);
            if (index > -1) {
                history.splice(index, 1);
            }
            // Eliminar en API
            deleteFromAPI(type, date);
        }
        
        // === API ===
        async function loadFromAPI() {
            try {
                const response = await fetch('/api/riego');
                if (response.ok) {
                    const data = await response.json();
                    // La API ahora devuelve arrays de fechas
                    if (data.jade && Array.isArray(data.jade)) {
                        wateringHistory.jade = data.jade.map(parseLocalDateString).filter(Boolean);
                    }
                    if (data.sansevieria && Array.isArray(data.sansevieria)) {
                        wateringHistory.sansevieria = data.sansevieria.map(parseLocalDateString).filter(Boolean);
                    }
                    if (data.canelo && Array.isArray(data.canelo)) {
                        wateringHistory.canelo = data.canelo.map(parseLocalDateString).filter(Boolean);
                    }
                    renderCalendar();
                }
            } catch (error) {
                console.log('API no disponible, usando datos locales');
            }
        }
        
        async function saveToAPI(planta, fecha) {
            try {
                await fetch('/api/riego', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planta, fecha: toLocalISODate(fecha) })
                });
            } catch (error) {
                console.log('Error guardando en API:', error);
            }
        }
        
        async function deleteFromAPI(planta, fecha) {
            try {
                await fetch('/api/riego', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planta, fecha: toLocalISODate(fecha) })
                });
            } catch (error) {
                console.log('Error eliminando en API:', error);
            }
        }

        // === C√°lculo del pr√≥ximo riego ===
        function getNextWatering(type) {
            const lastWatered = getLastWatered(type);
            let next = new Date(lastWatered);
            
            if (type === 'jade') {
                next.setDate(next.getDate() + JADE_INTERVAL);
            } else if (type === 'canelo') {
                next.setDate(next.getDate() + CANELO_INTERVAL);
            } else {
                next.setMonth(next.getMonth() + SANSEVIERIA_INTERVAL_MONTHS);
            }
            
            // Si ya pas√≥, avanzar hasta la pr√≥xima fecha v√°lida
            while (next < today) {
                if (type === 'jade') {
                    next.setDate(next.getDate() + JADE_INTERVAL);
                } else if (type === 'canelo') {
                    next.setDate(next.getDate() + CANELO_INTERVAL);
                } else {
                    next.setMonth(next.getMonth() + SANSEVIERIA_INTERVAL_MONTHS);
                }
            }
            
            return next;
        }

        // === Generar fechas de riego para el calendario ===
        // Combina: historial real de riegos + pr√≥ximos calculados desde el √∫ltimo
        function getScheduleDates(type, startDate, endDate) {
            const doneDates = [];
            const upcomingDates = [];
            const history = getWateringHistory(type);
            const lastWatered = getLastWatered(type);
            
            // 1. Agregar todos los riegos reales del historial
            for (const date of history) {
                if (date >= startDate && date <= endDate) {
                    doneDates.push(new Date(date));
                }
            }
            
            // 2. Calcular pr√≥ximos riegos desde el √∫ltimo
            if (type === 'jade') {
                let current = new Date(lastWatered);
                current.setDate(current.getDate() + JADE_INTERVAL);
                while (current <= endDate) {
                    if (!history.some(d => isSameDay(d, current))) {
                        upcomingDates.push(new Date(current));
                    }
                    current.setDate(current.getDate() + JADE_INTERVAL);
                }
            } else if (type === 'canelo') {
                let current = new Date(lastWatered);
                current.setDate(current.getDate() + CANELO_INTERVAL);
                while (current <= endDate) {
                    if (!history.some(d => isSameDay(d, current))) {
                        upcomingDates.push(new Date(current));
                    }
                    current.setDate(current.getDate() + CANELO_INTERVAL);
                }
            } else {
                // Sansevieria: mensual
                const targetDay = lastWatered.getDate();
                let monthOffset = 1;
                
                while (true) {
                    const year = lastWatered.getFullYear();
                    const month = lastWatered.getMonth() + monthOffset;
                    const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                    const day = Math.min(targetDay, lastDayOfMonth);
                    const current = new Date(year, month, day);
                    
                    if (current > endDate) break;
                    // Solo agregar si no est√° ya en el historial
                    if (!history.some(d => isSameDay(d, current))) {
                        upcomingDates.push(new Date(current));
                    }
                    monthOffset++;
                }
            }
            doneDates.sort((a, b) => a - b);
            upcomingDates.sort((a, b) => a - b);
            return { doneDates, upcomingDates };
        }

        function generateMonthCalendar(year, month, jadeDone, jadeUpcoming, sansevDone, sansevUpcoming) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startWeekDay = (firstDay.getDay() + 6) % 7;
            let html = `<div class="month-card" data-month="${month}"><div class="month-header">${monthNames[month]}</div><div class="month-body"><div class="weekdays">${weekDays.map(d => `<span>${d}</span>`).join('')}</div><div class="days">`;
            for (let i = 0; i < startWeekDay; i++) html += '<div class="day empty"></div>';
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                const isJadeDone = jadeDone.some(d => isSameDay(d, currentDate));
                const isSansevDone = sansevDone.some(d => isSameDay(d, currentDate));
                const isJadeUpcoming = jadeUpcoming.some(d => isSameDay(d, currentDate));
                const isSansevUpcoming = sansevUpcoming.some(d => isSameDay(d, currentDate));
                const isToday = isSameDay(currentDate, today);
                const isPast = currentDate < today && !isToday;
                let classes = ['day'];
                let tooltip = '';
                if (isJadeDone && isSansevDone) { classes.push('water-both-done'); tooltip = '‚úÖ Regado: Jade + Sansevieria'; }
                else if (isJadeUpcoming && isSansevUpcoming) { classes.push('water-both'); tooltip = 'ü™¥ Jade + üåø Sansevieria'; }
                else if (isJadeDone) { classes.push('water-jade-done'); tooltip = '‚úÖ Regado: Jade'; }
                else if (isSansevDone) { classes.push('water-sansevieria-done'); tooltip = '‚úÖ Regado: Sansevieria'; }
                else if (isJadeUpcoming) { classes.push('water-jade'); tooltip = 'ü™¥ Regar Jade (100ml)'; }
                else if (isSansevUpcoming) { classes.push('water-sansevieria'); tooltip = 'üåø Regar Sansevieria (100ml)'; }
                if (isToday) classes.push('today');
                if (isPast) classes.push('past');
                html += `<div class="${classes.join(' ')}" ${tooltip ? `data-tooltip="${tooltip}"` : ''} onmouseenter="showTooltip(event)" onmouseleave="hideTooltip()">${day}</div>`;
            }
            html += '</div></div></div>';
            return html;
        }

        function showTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            const text = event.target.dataset.tooltip;
            if (text) {
                tooltip.textContent = text;
                tooltip.style.left = event.pageX + 10 + 'px';
                tooltip.style.top = event.pageY - 30 + 'px';
                tooltip.classList.add('show');
                if (event.target.classList.contains('water-note-trigger')) {
                    tooltip.classList.add('wrap');
                }
            }
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show', 'wrap');
        }

        function renderCalendar() {
            const startDate = new Date(currentYear, 0, 1); // 1 de enero del a√±o
            const endDate = new Date(currentYear, 11, 31); // 31 de diciembre del a√±o
            const jadeDates = getScheduleDates('jade', startDate, endDate);
            const sansevDates = getScheduleDates('sansevieria', startDate, endDate);
            const caneloDates = getScheduleDates('canelo', startDate, endDate);
            
            // Renderizar calendario
            const grid = document.getElementById('calendar-grid');
            let html = '';
            for (let month = 0; month < 12; month++) {
                html += generateMonthCalendar(
                    currentYear,
                    month,
                    jadeDates.doneDates,
                    jadeDates.upcomingDates,
                    sansevDates.doneDates,
                    sansevDates.upcomingDates
                );
            }
            grid.innerHTML = html;
            document.getElementById('year-display').textContent = currentYear;
            
            // Estad√≠sticas del a√±o
            const jadeThisYear = jadeDates.doneDates.length + jadeDates.upcomingDates.length;
            const sansevThisYear = sansevDates.doneDates.length + sansevDates.upcomingDates.length;
            const caneloThisYear = caneloDates.doneDates.length + caneloDates.upcomingDates.length;
            const totalWater = ((jadeThisYear + sansevThisYear) * 100 + caneloThisYear * 80) / 1000;
            document.getElementById('total-jade').textContent = jadeThisYear;
            document.getElementById('total-sansevieria').textContent = sansevThisYear;
            document.getElementById('total-canelo').textContent = caneloThisYear;
            document.getElementById('total-water').textContent = totalWater.toFixed(1);
            
            // Pr√≥ximos riegos
            const nextJade = getNextWatering('jade');
            const nextSansev = getNextWatering('sansevieria');
            const nextCanelo = getNextWatering('canelo');
            
            // Tarjetas de plantas
            const daysJade = daysUntil(nextJade);
            document.getElementById('next-jade').innerHTML = 
                daysJade === 0 ? 'üíß ¬°Regar hoy!' : 
                daysJade === 1 ? 'üíß Regar ma√±ana' : 
                `üíß Pr√≥ximo: ${formatDate(nextJade)} (${daysJade} d√≠as)`;
            
            const daysSansev = daysUntil(nextSansev);
            document.getElementById('next-sansevieria').innerHTML = 
                daysSansev === 0 ? 'üíß ¬°Regar hoy!' : 
                daysSansev === 1 ? 'üíß Regar ma√±ana' : 
                `üíß Pr√≥ximo: ${formatDate(nextSansev)} (${daysSansev} d√≠as)`;
            
            const daysCanelo = daysUntil(nextCanelo);
            document.getElementById('next-canelo').innerHTML = 
                daysCanelo === 0 ? 'üíß ¬°Regar hoy!' : 
                daysCanelo === 1 ? 'üíß Regar ma√±ana' : 
                `üíß Pr√≥ximo: ${formatDate(nextCanelo)} (${daysCanelo} d√≠as)`;

            // Badge de hoy
            document.getElementById('today-badge').textContent = `Hoy: ${formatDate(today)} ${today.getFullYear()}`;

            // Mensaje principal: ¬øToca regar hoy?
            const jadeToday = isSameDay(nextJade, today);
            const sansevToday = isSameDay(nextSansev, today);
            const caneloToday = isSameDay(nextCanelo, today);
            const todayMessage = document.getElementById('today-message');
            
            const toWater = [];
            if (jadeToday) toWater.push('Jade');
            if (sansevToday) toWater.push('Sansevieria');
            if (caneloToday) toWater.push('Canelo');
            if (toWater.length > 0) {
                todayMessage.textContent = 'S√≠. ' + toWater.join(' y ') + '.';
                todayMessage.classList.remove('no');
            } else {
                todayMessage.textContent = 'No, hoy no toca.';
                todayMessage.classList.add('no');
            }

            // Pr√≥ximo riego general (el m√°s cercano de los tres)
            const nextAll = [nextJade, nextSansev, nextCanelo].reduce((a, b) => a < b ? a : b);
            const daysAll = daysUntil(nextAll);
            document.getElementById('today-sub').textContent = 
                `Pr√≥ximo riego: ${formatDateWithYear(nextAll)} (${daysAll} d√≠as)`;

            // Info de √∫ltimo riego
            const lastJade = getLastWatered('jade');
            const lastSansev = getLastWatered('sansevieria');
            
            const lastCanelo = getLastWatered('canelo');
            document.getElementById('last-jade-info').textContent = `√öltimo riego: ${formatDate(lastJade)}`;
            document.getElementById('last-sansev-info').textContent = `√öltimo riego: ${formatDate(lastSansev)}`;
            document.getElementById('last-canelo-info').textContent = `√öltimo riego: ${formatDate(lastCanelo)}`;

            // Scroll al mes actual
            if (currentYear === today.getFullYear()) {
                const monthCard = grid.querySelector(`.month-card[data-month="${today.getMonth()}"]`);
                if (monthCard) {
                    monthCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function changeYear(delta) {
            currentYear += delta;
            if (currentYear < 2024) currentYear = 2024;
            if (currentYear > 2030) currentYear = 2030;
            renderCalendar();
        }

        document.getElementById('today-badge').addEventListener('click', () => {
            currentYear = today.getFullYear();
            renderCalendar();
        });

        // === Modal y Toast ===
        const modalOverlay = document.getElementById('modal-overlay');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        const toast = document.getElementById('toast');
        const toastUndo = document.getElementById('toast-undo');
        
        let pendingPlant = null;
        let addedDate = null; // La fecha que se agreg√≥ (para poder deshacer)
        let toastTimeout = null;
        
        const plantNames = {
            jade: 'Jade',
            sansevieria: 'Sansevieria',
            canelo: 'Canelo'
        };
        
        const plantIcons = {
            jade: 'ü™¥',
            sansevieria: 'üåø',
            canelo: 'üå≤'
        };
        
        function showModal(plant) {
            pendingPlant = plant;
            modalIcon.textContent = plantIcons[plant];
            modalTitle.textContent = `¬øRegaste la ${plantNames[plant]} hoy?`;
            modalOverlay.classList.add('show');
        }
        
        function hideModal() {
            modalOverlay.classList.remove('show');
            // NO resetear pendingPlant aqu√≠, se necesita para el undo
        }
        
        function showToast() {
            // Cancelar timeout anterior si existe
            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }
            toast.classList.add('show');
            // Auto-ocultar despu√©s de 15 segundos
            toastTimeout = setTimeout(() => {
                hideToast();
            }, 15000);
        }
        
        function hideToast() {
            toast.classList.remove('show');
            addedDate = null;
            pendingPlant = null;
        }
        
        function undoWatering() {
            if (pendingPlant && addedDate) {
                removeWatering(pendingPlant, addedDate);
                renderCalendar();
                hideToast();
            }
        }
        
        // Event listeners
        modalCancel.addEventListener('click', hideModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) hideModal();
        });
        
        modalConfirm.addEventListener('click', () => {
            if (pendingPlant) {
                addedDate = new Date(today); // Guardar la fecha agregada
                addWatering(pendingPlant, today);
                renderCalendar();
                hideModal();
                showToast();
            }
        });
        
        toastUndo.addEventListener('click', undoWatering);
        
        // Botones "Regu√© hoy"
        document.querySelectorAll('.water-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const plant = btn.dataset.plant;
                showModal(plant);
            });
        });

        // Inicializar
        renderCalendar();
        // Cargar datos desde API (si est√° disponible)
        loadFromAPI();
    </script>
</body>
</html>
